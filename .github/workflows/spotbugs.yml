name: SpotBugs Code Quality Check

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/core/**'
      - '.github/workflows/spotbugs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/backend/core/**'
      - '.github/workflows/spotbugs.yml'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  spotbugs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "gradle"

      - name: Make gradlew executable
        run: chmod +x apps/backend/core/gradlew

      - name: Run SpotBugs analysis
        id: run_spotbugs
        continue-on-error: true
        run: |
          cd apps/backend/core
          ./gradlew spotbugsMain --no-daemon --console=plain

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: apps/backend/core/build/reports/spotbugs/main.sarif
          category: spotbugs

      - name: Analyze SpotBugs results
        if: always()
        id: analyze
        run: |
          cd apps/backend/core
          if [ -f build/reports/spotbugs/main.xml ]; then
            HIGH_BUGS=$(grep -o 'priority="1"' build/reports/spotbugs/main.xml | wc -l || echo "0")
            MEDIUM_BUGS=$(grep -o 'priority="2"' build/reports/spotbugs/main.xml | wc -l || echo "0")
            LOW_BUGS=$(grep -o 'priority="3"' build/reports/spotbugs/main.xml | wc -l || echo "0")

            echo "high_bugs=$HIGH_BUGS" >> $GITHUB_OUTPUT
            echo "medium_bugs=$MEDIUM_BUGS" >> $GITHUB_OUTPUT
            echo "low_bugs=$LOW_BUGS" >> $GITHUB_OUTPUT
            echo "has_report=true" >> $GITHUB_OUTPUT

            echo "### ğŸ” SpotBugs Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Priority | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”´ High   | $HIGH_BUGS |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¡ Medium | $MEDIUM_BUGS |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¢ Low    | $LOW_BUGS |" >> $GITHUB_STEP_SUMMARY

            if [ "$HIGH_BUGS" -gt "0" ] || [ "$MEDIUM_BUGS" -gt "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Action Required**: Please review and fix the high/medium priority bugs." >> $GITHUB_STEP_SUMMARY
              echo "::error::SpotBugs found $HIGH_BUGS high and $MEDIUM_BUGS medium priority bugs"
              exit 1
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **No critical bugs found!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "::error::SpotBugs report not found. The build might have failed before generating the report."
            echo "has_report=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request' && steps.analyze.outputs.has_report == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const high = '${{ steps.analyze.outputs.high_bugs }}';
            const medium = '${{ steps.analyze.outputs.medium_bugs }}';
            const low = '${{ steps.analyze.outputs.low_bugs }}';

            const status = (parseInt(high) + parseInt(medium)) > 0 ? 'âŒ' : 'âœ…';
            const message = `## ${status} SpotBugs Code Quality Report

            | Priority | Count |
            |----------|-------|
            | ğŸ”´ High   | ${high} |
            | ğŸŸ¡ Medium | ${medium} |
            | ğŸŸ¢ Low    | ${low} |

            ${(parseInt(high) + parseInt(medium)) > 0
              ? 'âš ï¸ **Please review and fix the high/medium priority bugs before merging.**'
              : 'âœ… **No critical bugs found!**'}
            
            ğŸ” Detailed issues can be found in the "Files changed" tab or "Security" tab.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
